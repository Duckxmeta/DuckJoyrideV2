<!DOCTYPE html>
<html>
<head>
    <title>Duck Joyride</title>
    <!-- Import Google Fonts: Playfair Display for titles and Inter for body text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            /* Set the website's primary background gradient */
            background: linear-gradient(145deg, #0f0f23, #1a1a3e, #2d1b69, #663399, #9966cc);
        }
        canvas { 
            display: block; 
            /* Add a subtle glow effect to the canvas, similar to the website's logo */
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.3));
            border-radius: 24px; /* Match the card border-radius */
        }
        /* This div will hold our game canvas */
        #game-container {
            border-radius: 24px;
            overflow: hidden; /* Ensures the canvas corners are rounded */
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <script src="https://telegram.org/js/games.js"></script>
</head>
<body>
    <div id="game-container"></div>
    <script>
        // --- THEME DEFINITION ---
        const Theme = {
            colors: {
                bgGradient: {
                    topLeft: '#0f0f23',
                    bottomRight: '#663399'
                },
                accentGradient: {
                    topLeft: '#ffd700',
                    topRight: '#ffed4e',
                    bottomLeft: '#f9ca24',
                    bottomRight: '#f39c12',
                },
                text: {
                    primary: '#ffffff',
                    secondary: 'rgba(255, 255, 255, 0.8)',
                    onAccent: '#1a1a3e',
                },
                glass: {
                    fill: 'rgba(255, 255, 255, 0.1)',
                    border: 'rgba(255, 215, 0, 0.3)',
                },
                shadow: 'rgba(0, 0, 0, 0.3)',
            },
            fonts: {
                headings: '"Playfair Display", serif',
                body: '"Inter", sans-serif',
            },
            borderRadius: {
                card: 24,
                button: 28,
            },
            shadow: {
                offsetX: 0,
                offsetY: 10,
                blur: 20,
                color: 0x000000,
                alpha: 0.3
            }
        };

        // --- UTILITY FUNCTIONS ---
        function createGradientTexture(scene, key, width, height, color1, color2, vertical = true) {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            const gradient = vertical ? ctx.createLinearGradient(0, 0, 0, height) : ctx.createLinearGradient(0, 0, width, 0);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            scene.textures.addCanvas(key, canvas);
        }

        function createGlassCard(scene, x, y, width, height) {
            const card = scene.add.graphics();
            card.fillStyle(Theme.shadow.color, Theme.shadow.alpha);
            card.fillRoundedRect(x + Theme.shadow.offsetX, y + Theme.shadow.offsetY, width, height, Theme.borderRadius.card);
            card.fillStyle(0xffffff, 0.1);
            card.fillRoundedRect(x, y, width, height, Theme.borderRadius.card);
            card.lineStyle(1, 0xffd700, 0.3);
            card.strokeRoundedRect(x, y, width, height, Theme.borderRadius.card);
            return card;
        }

        function createGoldButton(scene, x, y, text, onClick) {
            const width = 280;
            const height = 56;
            const sf = scaleFactor(scene);
            const buttonImage = scene.add.image(x, y, 'gold_button_gradient').setDisplaySize(width, height);
            const maskShape = scene.make.graphics();
            maskShape.fillStyle(0xffffff);
            maskShape.fillRoundedRect(x - width / 2, y - height / 2, width, height, Theme.borderRadius.button);
            const mask = maskShape.createGeometryMask();
            buttonImage.setMask(mask);
            const buttonText = scene.add.text(x, y, text, {
                fontFamily: Theme.fonts.body,
                fontSize: `${22 * sf}px`,
                color: Theme.colors.text.onAccent,
                fontStyle: 'bold'
            }).setOrigin(0.5);
            const hitArea = scene.add.zone(x, y, width, height).setInteractive({ useHandCursor: true });
            hitArea.on('pointerdown', onClick);
            hitArea.on('pointerover', () => { buttonImage.setAlpha(0.9); });
            hitArea.on('pointerout', () => { buttonImage.setAlpha(1); });
            return { bg: buttonImage, text: buttonText, zone: hitArea, mask: maskShape };
        }
        
        function scaleFactor(scene) {
            return Math.min(scene.game.config.width / 360, scene.game.config.height / 640);
        }

        // --- GLOBAL & ACHIEVEMENTS ---
        const isTelegram = typeof TelegramGameProxy !== 'undefined';
        const Global = { baseScrollSpeed: 200.0, currentScrollSpeed: 200.0 };
        const Achievements = {
             achievements: {
                 score_100: { unlocked: true, skin: "golden_duck", description: "Score 100: Golden Duck" },
                 score_500: { unlocked: true, skin: "cyber_duck", description: "Score 500: Cyber Duck" },
                 score_1000: { unlocked: true, skin: "rainbow_duck", description: "Score 1000: Rainbow Duck" },
                 fire_duck: { unlocked: false, skin: "fire_duck", description: "Fire Duck (Combo â‰¥ 100)", hidden: true },
                 ice_duck: { unlocked: false, skin: "ice_duck", description: "Ice Duck (3 deaths < 100 pts)", hidden: true },
                 toxic_duck: { unlocked: false, skin: "toxic_duck", description: "Toxic Duck (Game Over in Night)", hidden: true }
             },
             selectedSkin: "duck",
             consecutiveDeaths: 0,
             maxScoreThisSession: 0,
             loadAchievements() {
                 const savedData = localStorage.getItem("duckJoyrideAchievements");
                 if (savedData) {
                     const data = JSON.parse(savedData);
                     this.achievements = { ...this.achievements, ...data.achievements };
                     this.consecutiveDeaths = data.consecutiveDeaths || 0;
                     this.maxScoreThisSession = data.maxScoreThisSession || 0;
                     this.selectedSkin = data.selectedSkin || 'duck';
                 } else {
                     this.saveAchievements();
                 }
                 const validSkins = ['duck', 'golden_duck', 'cyber_duck', 'rainbow_duck', 'fire_duck', 'ice_duck', 'toxic_duck'];
                 this.selectedSkin = validSkins.includes(this.selectedSkin) ? this.selectedSkin : 'duck';
             },
             saveAchievements() {
                 localStorage.setItem("duckJoyrideAchievements", JSON.stringify({
                     achievements: this.achievements,
                     selectedSkin: this.selectedSkin,
                     consecutiveDeaths: this.consecutiveDeaths,
                     maxScoreThisSession: this.maxScoreThisSession
                 }));
             },
             checkAchievements(score) {
                 if (score >= 100 && !this.achievements.score_100.unlocked) this.achievements.score_100.unlocked = true;
                 if (score >= 500 && !this.achievements.score_500.unlocked) this.achievements.score_500.unlocked = true;
                 if (score >= 1000 && !this.achievements.score_1000.unlocked) this.achievements.score_1000.unlocked = true;
                 this.saveAchievements();
                 this.maxScoreThisSession = Math.max(this.maxScoreThisSession, score);
             },
             checkHiddenUnlocks(combo, deaths, isNightAtDeath) {
                 if (combo >= 100 && !this.achievements.fire_duck.unlocked) { this.achievements.fire_duck.unlocked = true; console.log("Fire Duck unlocked!"); }
                 if (deaths >= 3 && this.maxScoreThisSession < 100 && !this.achievements.ice_duck.unlocked) { this.achievements.ice_duck.unlocked = true; this.consecutiveDeaths = 0; console.log("Ice Duck unlocked!"); }
                 if (isNightAtDeath && !this.achievements.toxic_duck.unlocked) { this.achievements.toxic_duck.unlocked = true; console.log("Toxic Duck unlocked!"); }
                 this.saveAchievements();
             },
             resetSession() {
                 this.consecutiveDeaths = 0;
                 this.maxScoreThisSession = 0;
                 this.saveAchievements();
             },
             setSkin(skinName) {
                 this.selectedSkin = skinName;
                 this.saveAchievements();
             }
        };

        // --- SCENES ---

        class PreloaderScene extends Phaser.Scene {
            constructor() { super('PreloaderScene'); }

            preload() {
                createGradientTexture(this, 'bg_gradient', this.game.config.width, this.game.config.height, Theme.colors.bgGradient.topLeft, Theme.colors.bgGradient.bottomRight);
                createGradientTexture(this, 'gold_button_gradient', 280, 56, Theme.colors.accentGradient.topLeft, Theme.colors.accentGradient.bottomRight);

                this.load.image('day_sky', 'https://i.imgur.com/hU7gyqk.jpeg');
                this.load.image('night_sky', 'https://i.imgur.com/S48QAwt.jpeg');
                this.load.image('duck', 'https://i.imgur.com/pfFfvR0.png');
                this.load.image('golden_duck', 'https://i.imgur.com/htlvtIs.png');
                this.load.image('cyber_duck', 'https://i.imgur.com/mdhDPsN.png');
                this.load.image('rainbow_duck', 'https://i.imgur.com/yz3RYaz.png');
                this.load.image('fire_duck', 'https://i.imgur.com/HWEElmk.png');
                this.load.image('ice_duck', 'https://i.imgur.com/Xt85ys5.png');
                this.load.image('toxic_duck', 'https://i.imgur.com/suaE0NI.png');
                this.load.image('balloon', 'https://i.imgur.com/IWsLcKq.png');
                this.load.image('speed_boost', 'https://i.imgur.com/DP9TnzK.png');
                this.load.image('shield', 'https://i.imgur.com/QHL5YjX.png');
                this.load.image('shield_icon', 'https://i.imgur.com/QHL5YjX.png');
                this.load.image('pea_pod', 'https://i.imgur.com/5XkwkFy.png');
                this.load.image('magnet', 'https://i.imgur.com/8pRY5km.png');
                this.load.image('pea', 'https://i.imgur.com/An0FCpc.png');
                this.load.image('coin', 'https://i.imgur.com/JWNPyIs.png');
                this.load.image('rock', 'https://i.imgur.com/aZHb2XN.png');
                this.load.image('bird', 'https://i.imgur.com/hnrVw4d.png');
                this.load.image('star', 'https://i.imgur.com/JWNPyIs.png');
                this.load.image('particle', 'https://i.imgur.com/An0FCpc.png');
            }

            create() {
                this.scene.start('StartMenuScene');
            }
        }

        class StartMenuScene extends Phaser.Scene {
            constructor() { super('StartMenuScene'); }
            create() {
                this.add.image(this.game.config.width / 2, this.game.config.height / 2, 'bg_gradient');
                const centerX = this.game.config.width / 2;
                const sf = scaleFactor(this);
                this.add.text(centerX, 100, 'Duck Joyride', {
                    fontFamily: Theme.fonts.headings,
                    fontSize: `${48 * sf}px`,
                    color: Theme.colors.text.primary,
                }).setOrigin(0.5).setShadow(2, 2, Theme.colors.shadow, 2);
                const highScore = localStorage.getItem("duckJoyrideHighScore") || 0;
                this.add.text(centerX, 160, `High Score: ${highScore}`, {
                    fontFamily: Theme.fonts.body,
                    fontSize: `${20 * sf}px`,
                    color: Theme.colors.text.secondary,
                }).setOrigin(0.5);
                const buttons = [
                    { text: 'Start Game', action: () => this.scene.start('GameScene') },
                    { text: 'How to Play', action: () => this.scene.start('HowToPlayScene') },
                    { text: 'Skins', action: () => this.scene.start('AchievementsScene') },
                    { text: 'Leaderboard', action: () => this.scene.start('LeaderboardScene') },
                ];
                buttons.forEach((btn, index) => {
                    createGoldButton(this, centerX, 250 + index * 70, btn.text, btn.action);
                });
            }
        }
        
        class HowToPlayScene extends Phaser.Scene {
            constructor() { super('HowToPlayScene'); }
            create() {
                this.add.image(this.game.config.width / 2, this.game.config.height / 2, 'bg_gradient');
                const centerX = this.game.config.width / 2;
                const sf = scaleFactor(this);
                createGlassCard(this, 30, 60, 300, 450);
                this.add.text(centerX, 100, 'How to Play', {
                    fontFamily: Theme.fonts.headings,
                    fontSize: `${36 * sf}px`,
                    color: Theme.colors.text.primary,
                }).setOrigin(0.5);
                const instructions = 'Tap or press Space to fly up.\n\nAvoid rocks, birds, and balloons.\n\nCollect peas, coins, and stars for points.\n\nGrab power-ups for a boost!\n\nSurvive as long as you can!';
                this.add.text(centerX, 280, instructions, {
                    fontFamily: Theme.fonts.body,
                    fontSize: `${18 * sf}px`,
                    color: Theme.colors.text.secondary,
                    align: 'center',
                    wordWrap: { width: 280, useAdvancedWrap: true }
                }).setOrigin(0.5);
                createGoldButton(this, centerX, 560, 'Back to Menu', () => this.scene.start('StartMenuScene'));
            }
        }

        class AchievementsScene extends Phaser.Scene {
            constructor() { super('AchievementsScene'); }
            create() {
                this.add.image(this.game.config.width / 2, this.game.config.height / 2, 'bg_gradient');
                const centerX = this.game.config.width / 2;
                this.add.text(centerX, 60, 'Select a Skin', {
                    fontFamily: Theme.fonts.headings,
                    fontSize: `${36 * scaleFactor(this)}px`,
                    color: Theme.colors.text.primary,
                }).setOrigin(0.5);
                this.currentPage = 0;
                this.itemsPerPage = 3;
                this.achievementItems = [];
                this.updateAchievementsDisplay();
                createGoldButton(this, 90, 500, '<', () => this.changePage(-1));
                createGoldButton(this, 270, 500, '>', () => this.changePage(1));
                createGoldButton(this, centerX, 570, 'Back to Menu', () => this.scene.start('StartMenuScene'));
            }
            updateAchievementsDisplay() {
                this.achievementItems.forEach(item => {
                    item.card?.destroy();
                    item.text?.destroy();
                    if(item.button) {
                        item.button.bg.destroy();
                        item.button.text.destroy();
                        item.button.zone.destroy();
                        item.button.mask.destroy();
                    }
                });
                this.achievementItems = [];
                const skins = [
                    { name: 'duck', label: 'Classic Duck', unlocked: true }, { name: 'golden_duck', key: 'score_100' },
                    { name: 'cyber_duck', key: 'score_500' }, { name: 'rainbow_duck', key: 'score_1000' },
                    { name: 'fire_duck', key: 'fire_duck' }, { name: 'ice_duck', key: 'ice_duck' },
                    { name: 'toxic_duck', key: 'toxic_duck' }
                ];
                const totalPages = Math.ceil(skins.length / this.itemsPerPage);
                const startIdx = this.currentPage * this.itemsPerPage;
                const endIdx = startIdx + this.itemsPerPage;
                const paginatedSkins = skins.slice(startIdx, endIdx);
                let y = 120;
                paginatedSkins.forEach(skin => {
                    const achievement = skin.key ? Achievements.achievements[skin.key] : null;
                    const isUnlocked = skin.unlocked || (achievement ? achievement.unlocked : false);
                    if (!isUnlocked && achievement?.hidden) return;
                    const card = createGlassCard(this, 40, y, 280, 100);
                    const descText = achievement ? achievement.description : skin.label;
                    const statusText = isUnlocked ? 'Unlocked' : 'Locked';
                    const fullText = `${descText}\n(${statusText})`;
                    const text = this.add.text(180, y + 30, fullText, {
                        fontFamily: Theme.fonts.body,
                        fontSize: `${16 * scaleFactor(this)}px`,
                        color: Theme.colors.text.primary,
                        align: 'center'
                    }).setOrigin(0.5);
                    const buttonY = y + 75;
                    const button = createGoldButton(this, 180, buttonY, 'Select', () => { if (isUnlocked) Achievements.setSkin(skin.name); });
                    if (!isUnlocked) { button.bg.setAlpha(0.3); button.text.setAlpha(0.5); button.zone.disableInteractive(); }
                    this.achievementItems.push({ card, text, button });
                    y += 120;
                });
            }
            changePage(delta) {
                const totalSkins = 7;
                const totalPages = Math.ceil(totalSkins / this.itemsPerPage);
                this.currentPage = (this.currentPage + delta + totalPages) % totalPages;
                this.updateAchievementsDisplay();
            }
        }

        class LeaderboardScene extends Phaser.Scene {
             constructor() { super('LeaderboardScene'); }
             create() {
                this.add.image(this.game.config.width / 2, this.game.config.height / 2, 'bg_gradient');
                const centerX = this.game.config.width / 2;
                createGlassCard(this, 30, 150, 300, 250);
                this.add.text(centerX, 100, 'Leaderboard', {
                    fontFamily: Theme.fonts.headings,
                    fontSize: `${36 * scaleFactor(this)}px`,
                    color: Theme.colors.text.primary,
                }).setOrigin(0.5);
                const message = !isTelegram ? 'Leaderboards are only\navailable in Telegram!' : 'Check the leaderboard by\nusing /leaderboard\nin the Telegram chat!';
                this.add.text(centerX, 280, message, {
                    fontFamily: Theme.fonts.body,
                    fontSize: `${18 * scaleFactor(this)}px`,
                    color: Theme.colors.text.secondary,
                    align: 'center',
                    wordWrap: { width: 280, useAdvancedWrap: true }
                }).setOrigin(0.5);
                createGoldButton(this, centerX, 560, 'Back to Menu', () => this.scene.start('StartMenuScene'));
            }
        }

        class GameScene extends Phaser.Scene {
            constructor() { super('GameScene'); }
            
            create() {
                const { width, height } = this.game.config;
                // **MODIFICATION: Using a scrolling TileSprite for the in-game background**
                this.background = this.add.tileSprite(0, 0, width, height, 'day_sky').setOrigin(0, 0);
                this.background.setTileScale(width / this.textures.get('day_sky').width, height / this.textures.get('day_sky').height);


                const sf = scaleFactor(this);
                let playerSkin = Achievements.selectedSkin || 'duck';
                this.player = this.physics.add.sprite(45, 320, playerSkin).setCollideWorldBounds(true);
                this.player.setScale(0.5 * sf).setGravityY(800);
                if (this.player.body) this.player.body.setSize(this.player.width * 0.8, this.player.height * 0.8);

                this.peas = this.physics.add.group(); this.coins = this.physics.add.group(); this.stars = this.physics.add.group(); this.rocks = this.physics.add.group(); this.birds = this.physics.add.group(); this.balloons = this.physics.add.group(); this.speedBoosts = this.physics.add.group(); this.shields = this.physics.add.group(); this.peaPods = this.physics.add.group(); this.magnets = this.physics.add.group();
                
                const hudStyle = { fontFamily: Theme.fonts.body, fontSize: `${18 * sf}px`, color: '#000000', shadow: { offsetX: 1, offsetY: 1, color: '#fff', blur: 2, fill: true }};
                const hudStyleSmall = { ...hudStyle, fontSize: `${14 * sf}px`, color: '#333333' };
                this.scoreLabel = this.add.text(16, 16, 'Score: 0', hudStyle);
                this.levelLabel = this.add.text(16, 40, 'Level: 1', hudStyleSmall);
                this.comboLabel = this.add.text(16, 58, 'Combo: 0', hudStyleSmall);
                this.speedBoostLabel = this.add.text(width - 16, 16, '', hudStyleSmall).setOrigin(1, 0);
                this.peaPodLabel = this.add.text(width - 16, 34, '', hudStyleSmall).setOrigin(1, 0);
                this.magnetLabel = this.add.text(width - 16, 52, '', hudStyleSmall).setOrigin(1, 0);
                this.shieldIcon = this.add.image(width - 24, 80, 'shield_icon').setVisible(false).setScale(0.3 * sf);

                this.cursors = this.input.keyboard.createCursorKeys(); this.isTouching = false; this.input.on('pointerdown', () => this.isTouching = true); this.input.on('pointerup', () => this.isTouching = false);
                this.score = 0; this.level = 1; this.pointsToNextLevel = 100; this.comboCount = 0; this.gameOver = false; this.speedBoostActive = false; this.speedBoostTimer = 0; this.isInvincible = false; this.hasShield = false; this.peaMultiplierActive = false; this.peaMultiplierTimer = 0; this.magnetActive = false; this.magnetTimer = 0; this.dayNightTimer = 0; this.isNight = false;
                this.peaSpawnTimer = 0; this.starSpawnTimer = 0; this.speedBoostSpawnTimer = 0; this.shieldSpawnTimer = 30; this.peaPodSpawnTimer = 15; this.magnetSpawnTimer = 45; this.coinSpawnTimer = 20;
                this.powerUpParticles = this.add.particles('particle'); this.powerUpEmitter = this.powerUpParticles.createEmitter({ speed: { min: 30, max: 60 }, angle: { min: 0, max: 360 }, scale: { start: 0.2, end: 0 }, lifespan: 400, quantity: 5, on: false });
                this.hitParticles = this.add.particles('particle'); this.hitEmitter = this.hitParticles.createEmitter({ speed: { min: 50, max: 100 }, angle: { min: 0, max: 360 }, scale: { start: 0.3, end: 0 }, lifespan: 200, quantity: 8, on: false });
                this.speedTrail = this.add.particles('particle'); this.trailEmitter = this.speedTrail.createEmitter({ speed: 30, angle: 180, scale: { start: 0.1, end: 0 }, lifespan: 150, quantity: 1, on: false });
                this.physics.add.overlap(this.player, this.peas, this.collectPea, null, this); this.physics.add.overlap(this.player, this.coins, this.collectCoin, null, this); this.physics.add.overlap(this.player, this.stars, this.collectStar, null, this); this.physics.add.overlap(this.player, this.speedBoosts, this.collectSpeedBoost, null, this); this.physics.add.overlap(this.player, this.shields, this.collectShield, null, this); this.physics.add.overlap(this.player, this.peaPods, this.collectPeaPod, null, this); this.physics.add.overlap(this.player, this.magnets, this.collectMagnet, null, this); this.physics.add.overlap(this.player, [this.rocks, this.birds, this.balloons], this.hitObstacle, null, this);
            }

            update(time, delta) {
                const deltaSeconds = delta / 1000; 
                if (this.gameOver) return;

                // **MODIFICATION: Scrolling the tileSprite background**
                this.background.tilePositionX += Global.currentScrollSpeed * deltaSeconds * 0.1;

                this.dayNightTimer += deltaSeconds; 
                if (this.dayNightTimer >= 60) { 
                    this.dayNightTimer = 0; 
                    this.isNight = !this.isNight; 
                    // **MODIFICATION: Switching the texture of the tileSprite**
                    this.background.setTexture(this.isNight ? 'night_sky' : 'day_sky');
                }
                this.player.body.setVelocityY(this.isTouching || this.cursors.space.isDown ? -400 : this.player.body.velocity.y);
                if (this.speedBoostActive) { 
                    this.speedBoostTimer -= deltaSeconds; 
                    if (this.speedBoostTimer <= 0) { 
                        this.speedBoostActive = false; 
                        this.isInvincible = false; 
                        Global.currentScrollSpeed = Global.baseScrollSpeed * (1 + (this.level - 1) * 0.1); 
                        this.speedBoostLabel.setText(''); 
                        this.trailEmitter.stop(); 
                    } else { 
                        this.speedBoostLabel.setText(`Speed Boost: ${Math.ceil(this.speedBoostTimer)}s`); 
                        this.trailEmitter.start(); 
                        this.trailEmitter.setPosition(this.player.x - 20, this.player.y); 
                    } 
                } else { 
                    Global.currentScrollSpeed = Global.baseScrollSpeed * (1 + (this.level - 1) * 0.1); 
                    this.trailEmitter.stop(); 
                }
                if (this.peaMultiplierActive) { 
                    this.peaMultiplierTimer -= deltaSeconds; 
                    if (this.peaMultiplierTimer <= 0) { 
                        this.peaMultiplierActive = false; 
                        this.peaPodLabel.setText(''); 
                    } else { 
                        this.peaPodLabel.setText(`x2 Peas: ${Math.ceil(this.peaMultiplierTimer)}s`); 
                    } 
                }
                if (this.magnetActive) { 
                    this.magnetTimer -= deltaSeconds; 
                    if (this.magnetTimer <= 0) { 
                        this.magnetActive = false; 
                        this.magnetLabel.setText(''); 
                    } else { 
                        this.magnetLabel.setText(`Magnet: ${Math.ceil(this.magnetTimer)}s`); 
                        this.peas.getChildren().forEach(pea => { 
                            const distance = Phaser.Math.Distance.Between(this.player.x, this.player.y, pea.x, pea.y); 
                            if (distance <= 150) { 
                                const angle = Phaser.Math.Angle.Between(pea.x, pea.y, this.player.x, this.player.y); 
                                pea.x += Math.cos(angle) * 150 * deltaSeconds; 
                                pea.y += Math.sin(angle) * 150 * deltaSeconds; 
                            } 
                        }); 
                    } 
                }
                this.shieldIcon.setVisible(this.hasShield);
                this.peas.getChildren().forEach(p => { p.x -= Global.currentScrollSpeed * deltaSeconds; if (p.x < -50) p.destroy(); });
                this.coins.getChildren().forEach(c => { c.x -= Global.currentScrollSpeed * deltaSeconds; if (c.x < -50) c.destroy(); });
                this.stars.getChildren().forEach(s => { s.x -= Global.currentScrollSpeed * deltaSeconds; if (s.x < -50) s.destroy(); });
                this.rocks.getChildren().forEach(r => { r.x -= 200 * deltaSeconds; if (r.x < -50) r.destroy(); });
                this.birds.getChildren().forEach(b => { b.x -= 300 * deltaSeconds; if (b.x < -50) b.destroy(); });
                this.balloons.getChildren().forEach(b => { b.x -= 150 * deltaSeconds; if (b.x < -50) b.destroy(); });
                this.speedBoosts.getChildren().forEach(s => { s.x -= Global.currentScrollSpeed * deltaSeconds; if (s.x < -50) s.destroy(); });
                this.shields.getChildren().forEach(s => { s.x -= Global.currentScrollSpeed * deltaSeconds; if (s.x < -50) s.destroy(); });
                this.peaPods.getChildren().forEach(p => { p.x -= Global.currentScrollSpeed * deltaSeconds; if (p.x < -50) p.destroy(); });
                this.magnets.getChildren().forEach(m => { m.x -= Global.currentScrollSpeed * deltaSeconds; if (m.x < -50) m.destroy(); });
                this.peaSpawnTimer += deltaSeconds; if (this.peaSpawnTimer >= 1.5) { const c = Phaser.Math.Between(2, 4), y = Phaser.Math.Between(45, 595); for (let i = 0; i < c; i++) { const p = this.peas.create(this.game.config.width + 50 + i * 45, y, 'pea'); p.setScale(0.3 * scaleFactor(this)); if (p.body) p.body.setSize(p.width * 0.8, p.height * 0.8); } this.peaSpawnTimer = 0; }
                if (this.isNight) { this.starSpawnTimer += deltaSeconds; if (this.starSpawnTimer >= 10) { const s = this.stars.create(this.game.config.width + 50, Phaser.Math.Between(45, 595), 'star'); s.setScale(0.3 * scaleFactor(this)); if (s.body) s.body.setSize(s.width * 0.8, s.height * 0.8); this.starSpawnTimer = 0; } }
                const obstacleSpawnRate = 0.003 + (this.level - 1) * 0.0005; if (Math.random() < obstacleSpawnRate) { const r = this.rocks.create(this.game.config.width + 50, Phaser.Math.Between(45, 595), 'rock'); r.setScale(0.3 * scaleFactor(this)); if (r.body) r.body.setSize(r.width * 0.8, r.height * 0.8); } if (Math.random() < obstacleSpawnRate) { const b = this.birds.create(this.game.config.width + 50, Phaser.Math.Between(45, 595), 'bird'); b.setScale(0.3 * scaleFactor(this)); if (b.body) b.body.setSize(b.width * 0.8, b.height * 0.8); } if (Math.random() < obstacleSpawnRate) { const b = this.balloons.create(this.game.config.width + 50, Phaser.Math.Between(45, 595), 'balloon'); b.setScale(0.3 * scaleFactor(this)); if (b.body) b.body.setSize(b.width * 0.8, b.height * 0.8); }
                const powerUpSpawnDelay = 30; this.speedBoostSpawnTimer += deltaSeconds; if (this.speedBoostSpawnTimer >= powerUpSpawnDelay) { const s = this.speedBoosts.create(this.game.config.width + 50, Phaser.Math.Between(45, 595), 'speed_boost'); s.setScale(0.3 * scaleFactor(this)); if (s.body) s.body.setSize(s.width * 0.8, s.height * 0.8); this.speedBoostSpawnTimer = 0; } this.shieldSpawnTimer += deltaSeconds; if (this.shieldSpawnTimer >= powerUpSpawnDelay) { const s = this.shields.create(this.game.config.width + 50, Phaser.Math.Between(45, 595), 'shield'); s.setScale(0.3 * scaleFactor(this)); if (s.body) s.body.setSize(s.width * 0.8, s.height * 0.8); this.shieldSpawnTimer = 0; } this.peaPodSpawnTimer += deltaSeconds; if (this.peaPodSpawnTimer >= powerUpSpawnDelay) { const p = this.peaPods.create(this.game.config.width + 50, Phaser.Math.Between(45, 595), 'pea_pod'); p.setScale(0.3 * scaleFactor(this)); if (p.body) p.body.setSize(p.width * 0.8, p.height * 0.8); this.peaPodSpawnTimer = 0; } this.magnetSpawnTimer += deltaSeconds; if (this.magnetSpawnTimer >= powerUpSpawnDelay) { const m = this.magnets.create(this.game.config.width + 50, Phaser.Math.Between(45, 595), 'magnet'); m.setScale(0.3 * scaleFactor(this)); if (m.body) m.body.setSize(m.width * 0.8, m.height * 0.8); this.magnetSpawnTimer = 0; } this.coinSpawnTimer += deltaSeconds; if (this.coinSpawnTimer >= 20) { const c = this.coins.create(this.game.config.width + 50, Phaser.Math.Between(45, 595), 'coin'); c.setScale(0.3 * scaleFactor(this)); if (c.body) c.body.setSize(c.width * 0.8, c.height * 0.8); this.coinSpawnTimer = 0; }
            }
            checkLevelUp() { if (this.score >= this.pointsToNextLevel) { this.level++; this.pointsToNextLevel += 100 * this.level; this.levelLabel.setText(`Level: ${this.level}`); const t = this.add.text(180, 320, 'Level Up!', { fontFamily: Theme.fonts.body, fontSize: '24px', color: '#ffd700', shadow: { offsetX: 2, offsetY: 2, color: '#000', blur: 4, fill: true } }).setOrigin(0.5).setDepth(100).setScale(scaleFactor(this)); this.time.delayedCall(1000, () => t.destroy()); } }
            collectPea(p, pea) { if (this.gameOver) return; this.comboCount++; const m = this.comboCount >= 5 ? 1.5 : 1; let b = (this.peaMultiplierActive ? 2 : 1) * m; if (this.isNight) b *= 2; this.score += b; this.scoreLabel.setText(`Score: ${Math.floor(this.score)}`); this.comboLabel.setText(`Combo: ${this.comboCount}`); this.checkLevelUp(); pea.destroy(); }
            collectCoin(p, coin) { if (this.gameOver) return; this.comboCount++; const m = this.comboCount >= 5 ? 1.5 : 1; let b = 20 * m; if (this.isNight) b *= 2; this.score += b; this.scoreLabel.setText(`Score: ${Math.floor(this.score)}`); this.comboLabel.setText(`Combo: ${this.comboCount}`); this.checkLevelUp(); coin.destroy(); }
            collectStar(p, star) { if (this.gameOver) return; this.comboCount++; const m = this.comboCount >= 5 ? 1.5 : 1; let b = 50 * m; if (this.isNight) b *= 2; this.score += b; this.scoreLabel.setText(`Score: ${Math.floor(this.score)}`); this.comboLabel.setText(`Combo: ${this.comboCount}`); this.checkLevelUp(); star.destroy(); }
            collectSpeedBoost(p, sb) { if (this.gameOver) return; this.speedBoostActive = true; this.speedBoostTimer = 10; this.isInvincible = true; Global.currentScrollSpeed = Global.baseScrollSpeed * (1 + (this.level - 1) * 0.1) * 2; this.powerUpEmitter.emitParticleAt(sb.x, sb.y); sb.destroy(); }
            collectShield(p, s) { if (this.gameOver) return; this.hasShield = true; this.powerUpEmitter.emitParticleAt(s.x, s.y); s.destroy(); }
            collectPeaPod(p, pp) { if (this.gameOver) return; this.peaMultiplierActive = true; this.peaMultiplierTimer = 30; this.powerUpEmitter.emitParticleAt(pp.x, pp.y); pp.destroy(); }
            collectMagnet(p, m) { if (this.gameOver) return; this.magnetActive = true; this.magnetTimer = 30; this.powerUpEmitter.emitParticleAt(m.x, m.y); m.destroy(); }
            hitObstacle(p, o) { if (this.gameOver) return; if (this.isInvincible) { this.hitEmitter.emitParticleAt(o.x, o.y); o.destroy(); } else if (this.hasShield) { this.hasShield = false; this.hitEmitter.emitParticleAt(o.x, o.y); o.destroy(); } else { this.gameOver = true; this.score = Math.floor(this.score); let hs = parseInt(localStorage.getItem("duckJoyrideHighScore") || 0); if (this.score > hs) localStorage.setItem("duckJoyrideHighScore", this.score); Achievements.checkAchievements(this.score); Achievements.checkHiddenUnlocks(this.comboCount, Achievements.consecutiveDeaths + 1, this.isNight); if (this.score < 100) Achievements.consecutiveDeaths++; else Achievements.consecutiveDeaths = 0; this.scene.start('GameOverScene', { finalScore: this.score }); } this.comboCount = 0; this.comboLabel.setText(`Combo: ${this.comboCount}`); }
        }

        class GameOverScene extends Phaser.Scene {
            constructor() { super('GameOverScene'); }
            init(data) { this.finalScore = data.finalScore || 0; }
            create() {
                this.add.image(this.game.config.width / 2, this.game.config.height / 2, 'bg_gradient');
                const centerX = this.game.config.width / 2;
                createGlassCard(this, 30, 150, 300, 250);
                this.add.text(centerX, 200, 'Game Over', {
                    fontFamily: Theme.fonts.headings,
                    fontSize: `${48 * scaleFactor(this)}px`,
                    color: Theme.colors.text.primary,
                }).setOrigin(0.5);
                this.add.text(centerX, 280, `Final Score: ${this.finalScore}`, {
                    fontFamily: Theme.fonts.body,
                    fontSize: `${24 * scaleFactor(this)}px`,
                    color: Theme.colors.text.secondary,
                }).setOrigin(0.5);
                createGoldButton(this, centerX, 560, 'Return to Menu', () => {
                    Achievements.resetSession();
                    this.scene.start('StartMenuScene');
                });
            }
        }

        // --- PHASER CONFIG ---
        const config = {
            type: Phaser.AUTO,
            width: 360,
            height: 640,
            parent: 'game-container',
            physics: { default: 'arcade', arcade: { gravity: { y: 0 } } },
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH,
            },
            scene: [PreloaderScene, StartMenuScene, HowToPlayScene, AchievementsScene, LeaderboardScene, GameScene, GameOverScene]
        };

        Achievements.loadAchievements();
        const game = new Phaser.Game(config);
    </script>
</body>
</html>
